<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QuitBit Offline</title>
    <!-- Standalone configuration for mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#14b8a6">

    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --primary: #14b8a6;
            --primary-dark: #0d9488;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        /* DARK MODE VARS */
        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-stack);
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
        }

        button {
            inherit: none;
            border: none;
            background: none;
            cursor: pointer;
            font-family: inherit;
        }

        input,
        textarea {
            font-family: inherit;
        }

        /* --- LAYOUT UTILITIES --- */
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-body);
            position: relative;
        }

        .header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 100px;
            /* Space for nav */
        }

        .bottom-nav {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(var(--bg-card), 0.9);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(128, 128, 128, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0 20px 0;
            z-index: 10;
        }

        /* --- TYPOGRAPHY --- */
        h1 {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            background: -webkit-linear-gradient(45deg, #2dd4bf, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h2 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .text-sm {
            font-size: 0.875rem;
        }

        .text-xs {
            font-size: 0.75rem;
        }

        .text-muted {
            color: var(--text-muted);
        }

        .text-center {
            text-align: center;
        }

        .font-bold {
            font-weight: 700;
        }

        /* --- COMPONENTS --- */
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }

        .btn-icon:active {
            transform: scale(0.95);
        }

        .btn-panic {
            background-color: var(--danger);
            color: white;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }

        .btn-theme {
            background-color: rgba(128, 128, 128, 0.2);
            color: var(--text-muted);
        }

        .btn-fab {
            width: 56px;
            height: 56px;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: -30px;
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.4);
        }

        .card {
            background-color: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), rgba(20, 184, 166, 0.05));
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(20, 184, 166, 0.2);
        }

        .stat-val {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 600;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 2px;
        }

        /* --- WIDGETS --- */
        .progress-bar {
            background-color: rgba(128, 128, 128, 0.1);
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
            transition: width 0.5s ease;
        }

        .progress-fill.over-limit {
            background-color: var(--danger);
        }

        /* --- CHARTS (CSS ONLY) --- */
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .chart-toggles {
            background: rgba(128, 128, 128, 0.1);
            padding: 4px;
            border-radius: 8px;
            display: flex;
            gap: 4px;
        }

        .toggle-btn {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .toggle-btn.active {
            background: var(--bg-card);
            color: var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Scrollable container for many bars */
        .chart-scroll-wrapper {
            overflow-x: auto;
            padding-bottom: 10px;
            /* Space for scrollbar if any */
            margin: 0 -10px;
            /* Negative margin to fade edges? */
            padding: 0 10px;
        }

        .chart-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            /* Default for few items */
            height: 180px;
            padding-top: 30px;
            min-width: 100%;
            /* Ensure fits at least container */
        }

        .chart-container.scrollable {
            justify-content: flex-start;
            /* Stack left when scrolling */
            gap: 6px;
            width: max-content;
            /* Allow growth */
            padding-right: 20px;
        }

        .chart-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 30px;
            /* Fixed width for better touch targets in scroll mode */
            height: 100%;
            justify-content: flex-end;
            flex-shrink: 0;
            position: relative;
        }

        /* Tooltip behavior on hover/active */
        .chart-bar-group:active .chart-value-tooltip,
        .chart-bar-group:hover .chart-value-tooltip {
            opacity: 1;
            transform: translateY(0);
        }

        .chart-value-tooltip {
            position: absolute;
            top: -25px;
            background: var(--text-main);
            color: var(--bg-card);
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0;
            transform: translateY(5px);
            transition: all 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }

        .chart-bar {
            width: 12px;
            background-color: var(--primary);
            border-radius: 4px 4px 0 0;
            min-height: 4px;
            transition: height 0.5s;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .chart-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            text-align: center;
        }

        /* --- YEARLY HEATMAP --- */
        .year-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .year-nav-btn {
            background: rgba(128, 128, 128, 0.1);
            border-radius: 8px;
            padding: 4px 12px;
            font-weight: bold;
            color: var(--primary);
        }

        .heatmap-scroll {
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .heatmap-year {
            display: grid;
            grid-template-rows: repeat(7, 1fr);
            /* 7 Days rows */
            grid-auto-flow: column;
            /* Fill columns (weeks) first */
            gap: 3px;
            height: 100px;
            width: max-content;
            /* Let it grow horizontally */
        }

        .heatmap-cell {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background-color: rgba(128, 128, 128, 0.1);
        }

        .heatmap-cell.l0 {
            background-color: var(--success);
        }

        .heatmap-cell.l1 {
            background-color: #fcd34d;
        }

        .heatmap-cell.l2 {
            background-color: #f97316;
        }

        .heatmap-cell.l3 {
            background-color: var(--danger);
        }

        /* --- MODALS --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--bg-card);
            width: 90%;
            max-width: 320px;
            border-radius: 20px;
            padding: 24px;
            transform: scale(0.9);
            transition: transform 0.3s;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal.open .modal-content {
            transform: scale(1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(128, 128, 128, 0.2);
            background: var(--bg-body);
            color: var(--text-main);
            outline: none;
        }

        .input-field:focus {
            border-color: var(--primary);
        }

        .btn-block {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-weight: bold;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--text-muted);
            border: 1px solid rgba(128, 128, 128, 0.2);
        }

        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .trigger-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .trigger-btn {
            padding: 10px;
            border-radius: 10px;
            border: 1px solid transparent;
            background: rgba(128, 128, 128, 0.05);
            font-size: 0.85rem;
            color: var(--text-main);
            text-align: left;
        }

        .trigger-btn:hover {
            background: rgba(128, 128, 128, 0.1);
        }

        /* --- SOS OVERLAY --- */
        .sos-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #134e4a 0%, #0f172a 100%);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: opacity 0.5s;
        }

        .hidden {
            display: none !important;
        }

        .breathe-container {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .breathe-circle {
            position: absolute;
            background: rgba(45, 212, 191, 0.2);
            border-radius: 50%;
            inset: 0;
            animation: breathe-ripple 4s infinite ease-in-out;
        }

        .breathe-circle:nth-child(2) {
            animation-delay: 1s;
        }

        .breathe-circle:nth-child(3) {
            animation-delay: 2s;
        }

        .breathe-core {
            width: 100px;
            height: 100px;
            background: #2dd4bf;
            border-radius: 50%;
            box-shadow: 0 0 50px rgba(45, 212, 191, 0.6);
            animation: breathe-core 4s infinite ease-in-out;
            z-index: 10;
        }

        @keyframes breathe-ripple {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        @keyframes breathe-core {

            0%,
            100% {
                transform: scale(0.9);
                opacity: 0.9;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
                box-shadow: 0 0 70px rgba(45, 212, 191, 0.8);
            }
        }

        .quote-container {
            text-align: center;
            padding: 30px;
            max-width: 80%;
        }

        .sos-quote {
            font-size: 1.5rem;
            font-weight: 300;
            color: #ccfbf1;
            line-height: 1.6;
            margin-bottom: 20px;
            font-style: italic;
        }

        /* ICONS SVG */
        .icon-svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
    </style>
</head>

<body data-theme="dark">

    <!-- SOS Component -->
    <div class="sos-overlay hidden" id="sos-screen">
        <button onclick="app.toggleSOS()"
            style="position: absolute; top: 20px; right: 20px; color: white; opacity: 0.7;">
            <svg class="icon-svg" viewBox="0 0 24 24">
                <path
                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
            </svg>
        </button>

        <div class="breathe-container">
            <div class="breathe-circle"></div>
            <div class="breathe-circle"></div>
            <div class="breathe-circle"></div>
            <div class="breathe-core"></div>
        </div>

        <div class="quote-container">
            <h2 style="font-size: 1rem; letter-spacing: 4px; color: #5eead4; margin-bottom: 20px;">INHALA... EXHALA...
            </h2>
            <p id="sos-quote" class="sos-quote">"Esto tambi√©n pasar√°"</p>
        </div>
    </div>

    <div class="app-container">
        <header class="header">
            <div>
                <h1 onclick="app.switchTab('dashboard')" style="cursor: pointer;">QuitBit</h1>
                <p class="text-xs text-muted" id="current-date">Offline Mode</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="app.switchTab('dashboard')" class="btn-icon btn-theme" title="Inicio">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                    </svg>
                </button>
                <button onclick="app.toggleSOS()" class="btn-icon btn-panic">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
                    </svg>
                </button>
                <button onclick="app.toggleTheme()" class="btn-icon btn-theme">
                    <svg class="icon-svg" id="theme-icon" viewBox="0 0 24 24">
                        <path
                            d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z" />
                    </svg>
                </button>
            </div>
        </header>

        <main class="main-content" id="main-content">
            <!-- Content injected here -->
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="app.switchTab('dashboard')" id="nav-dash">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor" d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                </svg>
                Inicio
            </button>
            <button class="btn-fab" onclick="app.openModal('habit-modal')">
                <svg class="icon-svg" viewBox="0 0 24 24" style="width: 32px; height: 32px;">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg>
            </button>
            <button class="nav-item" onclick="app.switchTab('analytics')" id="nav-ana">
                <svg viewBox="0 0 24 24">
                    <path fill="currentColor"
                        d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                </svg>
                Progreso
            </button>
        </nav>
    </div>

    <!-- Modals -->
    <div id="habit-modal" class="modal">
        <div class="modal-content">
            <h2>Nuevo H√°bito</h2>
            <div class="form-group">
                <label class="text-xs text-muted font-bold">NOMBRE</label>
                <input type="text" id="habit-name" class="input-field" placeholder="Ej: Fumar">
            </div>
            <div class="form-group">
                <label class="text-xs text-muted font-bold">L√çMITE DIARIO: <span id="limit-val">5</span></label>
                <input type="range" id="habit-limit" min="0" max="20" value="5" style="width: 100%; margin-top: 10px;">
            </div>
            <div class="btn-row">
                <button class="btn-block btn-secondary" onclick="app.closeModal('habit-modal')">Cancelar</button>
                <button class="btn-block btn-primary" onclick="app.createHabit()">Crear</button>
            </div>
        </div>
    </div>

    <div id="trigger-modal" class="modal">
        <div class="modal-content">
            <h2>¬øQu√© pas√≥?</h2>
            <p class="text-sm text-muted" style="margin-bottom: 15px;">Identifica el disparador.</p>
            <div class="trigger-grid">
                <button class="trigger-btn" onclick="app.setTrigger('Estr√©s')">üòì Estr√©s</button>
                <button class="trigger-btn" onclick="app.setTrigger('Aburrimiento')">ü•± Aburrimiento</button>
                <button class="trigger-btn" onclick="app.setTrigger('Ansiedad')">üò∞ Ansiedad</button>
                <button class="trigger-btn" onclick="app.setTrigger('Social')">üçª Social</button>
            </div>
            <input type="text" id="custom-trigger" class="input-field" placeholder="Otro motivo...">
            <div class="btn-row">
                <button class="btn-block btn-secondary" onclick="app.closeModal('trigger-modal')">Cancelar</button>
                <button class="btn-block btn-primary" onclick="app.confirmLog()">Registrar</button>
            </div>
        </div>
    </div>

    <script>
        class App {
            constructor() {
                this.state = {
                    habits: [],
                    logs: [],
                    settings: { theme: 'dark' },
                    activeTab: 'dashboard',
                    tempHabitId: null,
                    chartView: 'month', // default
                    heatmapYear: new Date().getFullYear()
                };
                this.quotes = [
                    "No te preocupes por los pasos que no diste. Conc√©ntrate en el siguiente.",
                    "Tus peque√±os esfuerzos diarios suman grandes resultados.",
                    "La calma no es la ausencia de caos, es la paz en medio de √©l.",
                    "T√∫ tienes el control, no tus impulsos.",
                    "Respira. Esto es solo un momento. T√∫ eres para siempre.",
                    "Cada d√≠a es una nueva oportunidad para empezar de cero.",
                    "Siente el orgullo de estar intent√°ndolo.",
                    "El dolor de la disciplina es menor que el dolor del arrepentimiento.",
                    "Eres m√°s fuerte de lo que crees.",
                    "Todo pasa, todo se transforma. T√∫ tambi√©n puedes cambiar."
                ];
                this.init();
            }

            init() {
                this.loadData();
                this.applyTheme();
                this.renderDate();
                this.render();

                // Listeners for range
                document.getElementById('habit-limit').addEventListener('input', (e) => {
                    document.getElementById('limit-val').innerText = e.target.value;
                });
            }

            /* STORAGE */
            saveData() { localStorage.setItem('quitbit_v2', JSON.stringify(this.state)); }
            loadData() {
                const old = localStorage.getItem('quitbit_data');
                const current = localStorage.getItem('quitbit_v2');
                if (current) {
                    this.state = { ...this.state, ...JSON.parse(current) };
                    // Ensure year is set if coming from older ver
                    if (!this.state.heatmapYear) this.state.heatmapYear = new Date().getFullYear();
                } else if (old) {
                    const oldData = JSON.parse(old);
                    this.state.habits = oldData.habits || [];
                    this.state.logs = oldData.logs || [];
                    this.state.settings = oldData.settings || { theme: 'dark' };
                }
            }

            /* THEME */
            toggleTheme() {
                this.state.settings.theme = this.state.settings.theme === 'dark' ? 'light' : 'dark';
                this.applyTheme();
                this.saveData();
            }
            applyTheme() {
                document.body.setAttribute('data-theme', this.state.settings.theme);
            }

            /* LOGIC */
            renderDate() {
                const d = new Date();
                document.getElementById('current-date').innerText = d.toLocaleDateString();
            }

            switchTab(tab) {
                this.state.activeTab = tab;
                document.getElementById('nav-dash').classList.toggle('active', tab === 'dashboard');
                document.getElementById('nav-ana').classList.toggle('active', tab === 'analytics');
                this.render();
            }

            createHabit() {
                const name = document.getElementById('habit-name').value;
                const limit = document.getElementById('habit-limit').value;
                if (!name) return;
                this.state.habits.push({
                    id: Date.now().toString(),
                    name, limit: parseInt(limit), created: Date.now()
                });
                this.saveData();
                this.closeModal('habit-modal');
                document.getElementById('habit-name').value = '';
                this.render();
            }

            deleteHabit(id) {
                if (confirm('¬øBorrar h√°bito?')) {
                    this.state.habits = this.state.habits.filter(h => h.id !== id);
                    this.state.logs = this.state.logs.filter(l => l.habitId !== id);
                    this.saveData();
                    this.render();
                }
            }

            prepareLog(id) {
                this.state.tempHabitId = id;
                this.openModal('trigger-modal');
            }
            setTrigger(t) { document.getElementById('custom-trigger').value = t; }
            confirmLog() {
                const t = document.getElementById('custom-trigger').value || 'Otro';
                this.state.logs.push({
                    id: Date.now().toString(),
                    habitId: this.state.tempHabitId,
                    trigger: t,
                    timestamp: new Date().toISOString()
                });
                this.saveData();
                this.closeModal('trigger-modal');
                document.getElementById('custom-trigger').value = '';
                this.render();
            }

            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.state));
                const el = document.createElement('a');
                el.setAttribute("href", dataStr);
                el.setAttribute("download", "quitbit_offline_backup.json");
                document.body.appendChild(el);
                el.click();
                el.remove();
            }

            changeHeatmapYear(delta) {
                this.state.heatmapYear += delta;
                this.render();
            }

            /* MODALS */
            openModal(id) { document.getElementById(id).classList.add('open'); }
            closeModal(id) { document.getElementById(id).classList.remove('open'); }
            toggleSOS() {
                const el = document.getElementById('sos-screen');
                el.classList.toggle('hidden');
                if (!el.classList.contains('hidden')) {
                    document.getElementById('sos-quote').innerText = this.quotes[Math.floor(Math.random() * this.quotes.length)];
                }
            }

            /* RENDER ENGINE */
            render() {
                const container = document.getElementById('main-content');
                container.innerHTML = '';

                if (this.state.activeTab === 'dashboard') this.renderDashboard(container);
                else this.renderAnalytics(container);
            }

            renderDashboard(el) {
                if (!this.state.habits.length) {
                    el.innerHTML = '<div class="text-center text-muted" style="margin-top: 50px;">Creating Data...<br>A√±ade un h√°bito con (+)</div>';
                    return;
                }

                const today = new Date().toDateString();
                const todayLogs = this.state.logs.filter(l => new Date(l.timestamp).toDateString() === today);

                this.state.habits.forEach(h => {
                    const count = todayLogs.filter(l => l.habitId === h.id).length;
                    const pct = Math.min((count / (h.limit || 1)) * 100, 100);
                    const isOver = count > h.limit;

                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div>
                        <h3>${h.name}</h3>
                        <span class="text-xs text-muted">Meta: ${h.limit}</span>
                    </div>
                    <h2 class="${isOver ? 'text-danger' : 'text-primary'}" style="color: ${isOver ? 'var(--danger)' : 'var(--primary)'}">${count}</h2>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${isOver ? 'over-limit' : ''}" style="width: ${pct}%"></div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                    <button class="btn-icon" style="background:rgba(128,128,128,0.1); color: var(--text-muted);" onclick="app.deleteHabit('${h.id}')">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="width:16px; height:16px;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    </button>
                    <button class="btn-block btn-primary" style="width:auto; padding: 8px 16px; font-size: 0.9rem;" onclick="app.prepareLog('${h.id}')">
                        + Registrar
                    </button>
                </div>
            `;
                    el.appendChild(div);
                });
            }

            renderAnalytics(el) {
                const isMonth = this.state.chartView === 'month';

                // --- 1. Header & Stats ---
                const h2 = document.createElement('h2');
                h2.innerText = 'Estad√≠sticas';
                el.appendChild(h2);

                // Stats Logic
                const todayStr = new Date().toDateString();

                // Week Start (Monday) for Stats
                const now = new Date();
                const day = now.getDay(); // 0 (Sun) to 6 (Sat)
                const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
                const monday = new Date(now.setDate(diff));
                monday.setHours(0, 0, 0, 0);

                // Month Start
                const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

                const logsToday = this.state.logs.filter(l => new Date(l.timestamp).toDateString() === todayStr).length;
                const logsWeek = this.state.logs.filter(l => new Date(l.timestamp) >= monday).length;
                const logsMonth = this.state.logs.filter(l => new Date(l.timestamp) >= firstDayOfMonth).length;

                // Stat Grid
                const grid = document.createElement('div');
                grid.className = 'stat-grid';
                grid.innerHTML = `
            <div class="stat-card">
                <div class="stat-val">${logsToday}</div>
                <div class="stat-label">Hoy</div>
            </div>
            <div class="stat-card">
                <div class="stat-val">${logsWeek}</div>
                <div class="stat-label">Semana</div>
            </div>
            <div class="stat-card" style="grid-column: span 2;">
                <div class="stat-val">${logsMonth}</div>
                <div class="stat-label">Mes Actual</div>
            </div>
        `;
                el.appendChild(grid);

                // --- 2. Chart Section ---
                const chartCard = document.createElement('div');
                chartCard.className = 'card';

                // Header
                const chartHeader = document.createElement('div');
                chartHeader.className = 'chart-header';
                chartHeader.innerHTML = '<h3 class="text-sm text-muted">Incidencias</h3>';

                const toggles = document.createElement('div');
                toggles.className = 'chart-toggles';

                const btnWeek = document.createElement('button');
                btnWeek.className = `toggle-btn ${!isMonth ? 'active' : ''}`;
                btnWeek.innerText = 'Semana';
                btnWeek.onclick = () => { this.state.chartView = 'week'; this.render(); };

                const btnMonth = document.createElement('button');
                btnMonth.className = `toggle-btn ${isMonth ? 'active' : ''}`;
                btnMonth.innerText = 'Mes';
                btnMonth.onclick = () => { this.state.chartView = 'month'; this.render(); };

                toggles.appendChild(btnWeek);
                toggles.appendChild(btnMonth);
                chartHeader.appendChild(toggles);
                chartCard.appendChild(chartHeader);

                // Chart Wrapper to hold Y-Axis + Scroll Area
                const chartWrapper = document.createElement('div');
                chartWrapper.style.display = 'flex';
                chartWrapper.style.height = '180px';
                chartWrapper.style.paddingTop = '20px';

                // Data Processing
                let daysToRender = [];
                let max = 0;

                if (!isMonth) {
                    // Monday to Sunday (Current Week)
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(monday);
                        d.setDate(monday.getDate() + i);
                        daysToRender.push(d);
                    }
                } else {
                    // Current Month
                    const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
                    for (let i = 1; i <= daysInMonth; i++) {
                        daysToRender.push(new Date(new Date().getFullYear(), new Date().getMonth(), i));
                    }
                }

                // Calculate counts and max first
                const dataList = daysToRender.map(d => {
                    const dateStr = d.toDateString();
                    const count = this.state.logs.filter(l => new Date(l.timestamp).toDateString() === dateStr).length;
                    if (count > max) max = count;

                    let label = d.toLocaleDateString('es-ES', { weekday: 'short' })[0];
                    if (isMonth) label = d.getDate();

                    return { label, count, date: dateStr };
                });

                if (max === 0) max = 5; // Min height for scale
                else if (max < 5) max = 5; // Minimum scale of 5 for aesthetics

                // Y-Axis
                const yAxis = document.createElement('div');
                yAxis.style.display = 'flex';
                yAxis.style.flexDirection = 'column-reverse';
                yAxis.style.justifyContent = 'space-between';
                yAxis.style.paddingRight = '10px';
                yAxis.style.borderRight = '1px solid rgba(128,128,128,0.2)';
                yAxis.style.marginRight = '5px';
                yAxis.style.fontSize = '0.7rem';
                yAxis.style.color = 'var(--text-muted)';
                yAxis.style.height = '100%';
                yAxis.style.paddingBottom = '15px'; // Align with bars base

                // Create 3-4 steps for Y-Axis
                const steps = 4; // 0, 1/3, 2/3, max
                for (let i = 0; i <= steps; i++) {
                    const val = Math.round((max / steps) * i);
                    const span = document.createElement('div');
                    // Hack to align vertically: flex-col-reverse distributes them.
                    // We want text to line up with the value height.
                    // Simple approach: space-between covers 0% to 100% height.
                    span.innerText = val;
                    span.style.height = '0'; // Don't take space in flow, just position markers
                    span.style.display = 'flex';
                    span.style.alignItems = 'center';
                    yAxis.appendChild(span);
                }
                chartWrapper.appendChild(yAxis);

                // Scroll Container
                const scrollWrapper = document.createElement('div');
                scrollWrapper.className = 'chart-scroll-wrapper';
                scrollWrapper.style.flex = '1';

                const chartCont = document.createElement('div');
                chartCont.className = isMonth ? 'chart-container scrollable' : 'chart-container';
                chartCont.style.height = '100%';
                chartCont.style.paddingTop = '0'; // Reset padding as wrapper handles it

                dataList.forEach(d => {
                    const height = (d.count / max) * 100;
                    const barWidth = isMonth ? '16px' : '70%';

                    chartCont.innerHTML += `
                <div class="chart-bar-group" style="${isMonth ? 'width: 25px;' : ''}">
                    <div class="chart-value-tooltip">${d.count}</div>
                    <div class="chart-bar" style="height: ${height}%; width: ${barWidth}" title="${d.count}"></div>
                    <span class="chart-label">${d.label}</span>
                </div>
            `;
                });

                scrollWrapper.appendChild(chartCont);
                chartWrapper.appendChild(scrollWrapper);
                chartCard.appendChild(chartWrapper);
                el.appendChild(chartCard);

                // --- 3. Yearly Heatmap ---
                const heatCard = document.createElement('div');
                heatCard.className = 'card';
                // Year Nav Header
                const yearHead = document.createElement('div');
                yearHead.className = 'year-header';
                yearHead.innerHTML = `
            <button class="year-nav-btn" onclick="app.changeHeatmapYear(-1)"><</button>
            <h3 class="text-sm">Mapa de Calor ${this.state.heatmapYear}</h3>
            <button class="year-nav-btn" onclick="app.changeHeatmapYear(1)">></button>
        `;
                heatCard.appendChild(yearHead);

                // Scroll container
                const heatScroll = document.createElement('div');
                heatScroll.className = 'heatmap-scroll';

                const heatGrid = document.createElement('div');
                heatGrid.className = 'heatmap-year';
                heatGrid.id = 'heatmap-grid';

                heatScroll.appendChild(heatGrid);
                heatCard.appendChild(heatScroll);
                el.appendChild(heatCard);

                setTimeout(() => this.fillYearHeapmap(heatGrid), 0);

                // Export
                const btn = document.createElement('button');
                btn.className = 'btn-block btn-secondary';
                btn.style.marginTop = '20px';
                btn.innerText = 'Descargar CSV';
                btn.onclick = () => this.exportData();
                el.appendChild(btn);
            }

            fillYearHeapmap(container) {
                const year = this.state.heatmapYear;
                const startDate = new Date(year, 0, 1);
                const endDate = new Date(year, 11, 31);

                // We typically render 52/53 columns for weeks, 7 rows for days
                // We iterate day by day

                // Clear logic: GitHub style fills vertical (Sun-Sat), then moves right
                // So standard grid-auto-flow: column works if we put correct number of cells

                // Calculate daysDiff
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                // Reset container to clear previous
                container.innerHTML = '';

                for (let i = 0; i < diffDays; i++) {
                    const d = new Date(year, 0, 1 + i);
                    const dateStr = d.toDateString();
                    const count = this.state.logs.filter(l => new Date(l.timestamp).toDateString() === dateStr).length;

                    const cell = document.createElement('div');
                    cell.title = `${d.toLocaleDateString()}: ${count}`;
                    cell.className = 'heatmap-cell ' + (count === 0 ? 'l0' : count < 3 ? 'l1' : count < 6 ? 'l2' : 'l3');
                    container.appendChild(cell);
                }
            }
        }

        const app = new App();
    </script>
</body>

</html>
